import"./multi-wallet-connector-0c891252.js";import"./user-store-6f34e326.js";import"./image-handler-91d970e9.js";class e{constructor(){this.selectedFile=null,this.selectedCategory=null,this.init()}async init(){this.setupEventListeners(),await this.checkWalletConnection()}setupEventListeners(){document.addEventListener("click",e=>{"connectWallet"===e.target.id&&this.handleWalletConnection()});const e=document.getElementById("mobileMenuToggle"),t=document.getElementById("mobileMenu");e&&t&&(e.addEventListener("click",()=>{t.classList.toggle("active")}),document.addEventListener("click",s=>{e.contains(s.target)||t.contains(s.target)||t.classList.remove("active")})),this.setupImageUpload(),this.setupCategorySelection(),this.setupFormSubmission()}setupImageUpload(){const e=document.getElementById("nftImage"),t=document.getElementById("imagePreview");document.getElementById("previewImage"),t.querySelector(".upload-placeholder"),e&&e.addEventListener("change",e=>{this.handleFileSelect(e.target.files[0])}),t&&t.addEventListener("click",()=>{null==e||e.click()}),t&&(["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,this.preventDefaults,!1),document.body.addEventListener(e,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,()=>{t.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,()=>{t.classList.remove("drag-over")},!1)}),t.addEventListener("drop",e=>{const t=e.dataTransfer.files;t.length>0&&this.handleFileSelect(t[0])},!1))}preventDefaults(e){e.preventDefault(),e.stopPropagation()}setupCategorySelection(){const e=document.querySelectorAll(".category-option");e.forEach(t=>{t.addEventListener("click",s=>{s.preventDefault(),e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),this.selectedCategory=t.dataset.category})})}setupFormSubmission(){const e=document.getElementById("nftUploadForm");e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleMintNFT()})}async checkWalletConnection(){console.log("Upload: checkWalletConnection called"),window.walletState&&window.walletState.isConnected||this.showConnectWalletPrompt()}async handleWalletConnection(){if(console.log("Upload: handleWalletConnection called"),window.walletState&&window.walletState.isConnected)window.disconnectWalletDirect&&window.disconnectWalletDirect(),this.showConnectWalletPrompt();else if(window.connectWalletDirect)try{await window.connectWalletDirect(),window.walletState&&window.walletState.isConnected&&this.hideConnectWalletPrompt()}catch(e){console.error("Upload: Wallet connection failed",e)}else console.error("Upload: Direct wallet connection not available")}showConnectWalletPrompt(){const e=document.getElementById("uploadForm"),t=document.getElementById("connectWalletPrompt");e&&(e.style.display="none"),t&&(t.style.display="block")}hideConnectWalletPrompt(){const e=document.getElementById("uploadForm"),t=document.getElementById("connectWalletPrompt");e&&(e.style.display="block"),t&&(t.style.display="none")}handleFileSelect(e){if(!e)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type.toLowerCase()))return void this.showMessage("Please select a valid image file (JPEG, PNG, GIF, WebP)","error");if(e.size>10485760)return void this.showMessage("File size must be less than 10MB","error");this.selectedFile=e;const t=document.getElementById("previewImage"),s=document.querySelector(".upload-placeholder"),l=document.getElementById("imagePreview");if(e.type.startsWith("image/")){const o=new FileReader;o.onload=e=>{t&&s&&l&&(t.src=e.target.result,t.style.display="block",s.style.display="none",l.classList.add("has-image"))},o.readAsDataURL(e)}}async handleMintNFT(){var e,t,s,l,o,n;if(!window.walletState||!window.walletState.isConnected)return void this.showMessage("Please connect your wallet first.","error");const a=null==(t=null==(e=document.getElementById("nftTitle"))?void 0:e.value)?void 0:t.trim(),i=null==(l=null==(s=document.getElementById("nftDescription"))?void 0:s.value)?void 0:l.trim(),r=null==(o=document.getElementById("nftPrice"))?void 0:o.value,d=(null==(n=document.getElementById("royaltyPercentage"))?void 0:n.value)||5;if(!a||!r||!this.selectedFile)return void this.showMessage("Please fill in all required fields and select an image.","error");if(!this.selectedCategory)return void this.showMessage("Please select a category for your NFT.","error");if(parseFloat(r)<=0)return void this.showMessage("Price must be greater than 0 ETH.","error");const c=window.walletState.address;if(!window.userStore.isArtistRegistered(c))return this.showMessage("You must be a registered artist to mint NFTs.","error"),void setTimeout(()=>{window.location.href="artist-register.html"},2e3);const m=document.querySelector('button[type="submit"]'),u=m.querySelector(".btn-text"),g=m.querySelector(".btn-loading"),y=document.getElementById("uploadProgress"),p=document.getElementById("progressFill");m&&(m.disabled=!0,u.style.display="none",g.style.display="inline-block"),y&&(y.style.display="block");try{this.updateProgress(p,20);const e=await window.imageHandler.processImage(this.selectedFile);this.updateProgress(p,60);const t={name:a,description:i||"No description provided",price:parseFloat(r),creator:c,image:e.imageId,category:this.selectedCategory,royalty:parseInt(d),createdAt:Date.now(),status:"for-sale"};this.updateProgress(p,80);window.userStore.createNFT(t);this.updateProgress(p,100),setTimeout(()=>{this.showMessage(`NFT "${a}" created successfully!`,"success"),this.resetForm(),m&&(m.disabled=!1,u.style.display="inline",g.style.display="none"),y&&(y.style.display="none"),setTimeout(()=>{window.location.href="profile.html"},2e3)},1e3)}catch(h){console.error("Minting error:",h),this.showMessage("Failed to create NFT: "+h.message,"error"),m&&(m.disabled=!1,u.style.display="inline",g.style.display="none"),y&&(y.style.display="none")}}updateProgress(e,t){e&&(e.style.width=t+"%")}showMessage(e,t="info"){let s=document.getElementById("uploadMessage");if(!s){s=document.createElement("div"),s.id="uploadMessage",s.className="upload-message";const e=document.getElementById("nftUploadForm");e&&e.insertBefore(s,e.firstChild)}s.className=`upload-message ${t}`,s.textContent=e,s.style.display="block",setTimeout(()=>{s&&(s.style.display="none")},5e3)}resetForm(){const e=document.getElementById("nftUploadForm");e&&e.reset();const t=document.getElementById("previewImage"),s=document.querySelector(".upload-placeholder"),l=document.getElementById("imagePreview");t&&(t.style.display="none",t.src=""),s&&(s.style.display="block"),l&&l.classList.remove("has-image");document.querySelectorAll(".category-option").forEach(e=>e.classList.remove("selected")),this.selectedFile=null,this.selectedCategory=null;const o=document.getElementById("uploadMessage");o&&(o.style.display="none")}}document.addEventListener("DOMContentLoaded",()=>{new e});
